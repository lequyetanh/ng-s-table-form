import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { debounce } from 'lodash';
import { debounceTime, distinctUntilChanged, tap } from 'rxjs';
import { FormControl } from '@angular/forms';
import * as i0 from "@angular/core";
import * as i1 from "@angular/forms";
import * as i2 from "@angular/common";
export class NgSTableFormComponent {
    constructor(elementRef) {
        this.elementRef = elementRef;
        this.loadMoreItemEvent = new EventEmitter();
        this.changeItemSelectedEvent = new EventEmitter();
        this.searchItemEvent = new EventEmitter();
        this.showDropdownList = false;
        this.inSide = false;
        this.loadMoreItem = debounce(($event) => {
            const target = $event.target;
            if (target.scrollTop === 0) {
                return;
            }
            if (target.offsetHeight + target.scrollTop >= target.scrollHeight - 50) {
                this.loadMoreItemEvent.emit(true);
            }
        }, 100);
    }
    ngOnInit() {
        this.keyword$ = new FormControl(this.itemSelected.name);
        this.searchItem();
    }
    ngOnChanges() {
        if (this.itemSelected.change) {
            this.keyword$?.setValue(this.itemSelected.name, { emitEvent: false });
            this.itemSelected.change = false;
        }
    }
    mouseOverTable() {
        this.inSide = true;
    }
    mouseLeaveTable() {
        this.inSide = false;
    }
    onClickOutside() {
        if (!this.inSide) {
            this.showDropdownList = false;
            if (!this.listItem.length && this.itemSelected) {
                this.keyword$.setValue(this.itemSelected.name);
            }
            if (this.listItem.length && this.itemSelected && !this.listItemFilter.keyword) {
                this.keyword$?.setValue(this.itemSelected.name, { emitEvent: false });
            }
        }
    }
    changeItemSelected(item, event) {
        event.stopPropagation();
        this.keyword$.setValue(item.name, { emitEvent: false });
        this.changeItemSelectedEvent.emit(item);
        this.showDropdownList = false;
    }
    searchItem() {
        this.keyword$.valueChanges
            .pipe(debounceTime(500), distinctUntilChanged(), tap(value => {
            if (value) {
                this.listItemFilter.keyword = value;
                this.listItemFilter.page = 0;
            }
            else {
                this.listItemFilter.keyword = '';
            }
        }))
            .subscribe(() => {
            this.searchItemEvent.emit(this.listItemFilter.keyword);
        });
    }
}
NgSTableFormComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: NgSTableFormComponent, deps: [{ token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Component });
NgSTableFormComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.3.0", type: NgSTableFormComponent, selector: "ng-s-table-form", inputs: { listItem: "listItem", listItemFilter: "listItemFilter", itemSelected: "itemSelected", dataTableInput: "dataTableInput", disableForm: "disableForm" }, outputs: { loadMoreItemEvent: "loadMoreItemEvent", changeItemSelectedEvent: "changeItemSelectedEvent", searchItemEvent: "searchItemEvent" }, viewQueries: [{ propertyName: "divElement", first: true, predicate: ["divElement"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<div [ngStyle]=\"{ 'pointer-events': disableForm ? 'none' : '' }\" class=\"combobox\" #divElement (focusout)=\"onClickOutside()\" (mouseover)=\"mouseOverTable()\" (mouseleave)=\"mouseLeaveTable()\">\r\n  <!--    <div>{{itemSelected | json}}</div>-->\r\n  <input class=\"item-select\" [title]=\"itemSelected.name\" type=\"search\" (click)=\"showDropdownList = true\" [formControl]=\"keyword$\" />\r\n  <div class=\"dropdown-content\" *ngIf=\"showDropdownList\" (scroll)=\"loadMoreItem($event)\">\r\n    <table>\r\n      <thead>\r\n        <tr>\r\n          <ng-container *ngFor=\"let header of dataTableInput.header\">\r\n            <th class=\"col-3 text-center\">{{ header.label }}</th>\r\n          </ng-container>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        <ng-container *ngIf=\"listItem.length; else noItem\">\r\n          <ng-container *ngFor=\"let item of listItem\">\r\n            <tr [class.active]=\"item.id == itemSelected.id\" (click)=\"changeItemSelected(item, $event)\">\r\n              <ng-container *ngFor=\"let body of dataTableInput.header\">\r\n                <td\r\n                  [class]=\"'col-' + 12 / dataTableInput.header.length\"\r\n                  class=\"item-info\"\r\n                  [class.col-2]=\"body.value == 'taxCode'\"\r\n                  [title]=\"item[body.value]\"\r\n                >\r\n                  {{ item[body.value] }}\r\n                </td>\r\n              </ng-container>\r\n            </tr>\r\n          </ng-container>\r\n        </ng-container>\r\n        <ng-template #noItem>\r\n          <tr>\r\n            <td colspan=\"4\">D\u1EEF li\u1EC7u kh\u00F4ng t\u1ED3n t\u1EA1i trong danh m\u1EE5c</td>\r\n          </tr>\r\n        </ng-template>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n</div>\r\n", styles: [".combobox{width:100%;height:37px;position:relative}.combobox .item-select{width:100%;height:36px;padding:6px 10px;border:1px solid #d3d3d3;border-radius:4px;outline:none}.combobox .dropdown-content{position:absolute;top:37px;left:0;z-index:3;max-width:120%;max-height:200px;overflow:auto;border-radius:4px}.combobox .dropdown-content th:first-child{text-align:left;padding:0 5px!important}.combobox .dropdown-content table{width:600px;max-width:100%;background-color:#fff}.combobox .dropdown-content table th,.combobox .dropdown-content table td{border:1px solid #b0d4eb;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:150px!important;min-width:120px!important;padding:5px}.combobox .dropdown-content table thead{position:sticky;top:-1px;color:#004671}.combobox .dropdown-content table tbody tr:hover,.combobox .dropdown-content table .active{background-color:#e6f1f8}\n"], dependencies: [{ kind: "directive", type: i1.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { kind: "directive", type: i1.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i1.FormControlDirective, selector: "[formControl]", inputs: ["formControl", "disabled", "ngModel"], outputs: ["ngModelChange"], exportAs: ["ngForm"] }, { kind: "directive", type: i2.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i2.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: NgSTableFormComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ng-s-table-form', template: "<div [ngStyle]=\"{ 'pointer-events': disableForm ? 'none' : '' }\" class=\"combobox\" #divElement (focusout)=\"onClickOutside()\" (mouseover)=\"mouseOverTable()\" (mouseleave)=\"mouseLeaveTable()\">\r\n  <!--    <div>{{itemSelected | json}}</div>-->\r\n  <input class=\"item-select\" [title]=\"itemSelected.name\" type=\"search\" (click)=\"showDropdownList = true\" [formControl]=\"keyword$\" />\r\n  <div class=\"dropdown-content\" *ngIf=\"showDropdownList\" (scroll)=\"loadMoreItem($event)\">\r\n    <table>\r\n      <thead>\r\n        <tr>\r\n          <ng-container *ngFor=\"let header of dataTableInput.header\">\r\n            <th class=\"col-3 text-center\">{{ header.label }}</th>\r\n          </ng-container>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        <ng-container *ngIf=\"listItem.length; else noItem\">\r\n          <ng-container *ngFor=\"let item of listItem\">\r\n            <tr [class.active]=\"item.id == itemSelected.id\" (click)=\"changeItemSelected(item, $event)\">\r\n              <ng-container *ngFor=\"let body of dataTableInput.header\">\r\n                <td\r\n                  [class]=\"'col-' + 12 / dataTableInput.header.length\"\r\n                  class=\"item-info\"\r\n                  [class.col-2]=\"body.value == 'taxCode'\"\r\n                  [title]=\"item[body.value]\"\r\n                >\r\n                  {{ item[body.value] }}\r\n                </td>\r\n              </ng-container>\r\n            </tr>\r\n          </ng-container>\r\n        </ng-container>\r\n        <ng-template #noItem>\r\n          <tr>\r\n            <td colspan=\"4\">D\u1EEF li\u1EC7u kh\u00F4ng t\u1ED3n t\u1EA1i trong danh m\u1EE5c</td>\r\n          </tr>\r\n        </ng-template>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n</div>\r\n", styles: [".combobox{width:100%;height:37px;position:relative}.combobox .item-select{width:100%;height:36px;padding:6px 10px;border:1px solid #d3d3d3;border-radius:4px;outline:none}.combobox .dropdown-content{position:absolute;top:37px;left:0;z-index:3;max-width:120%;max-height:200px;overflow:auto;border-radius:4px}.combobox .dropdown-content th:first-child{text-align:left;padding:0 5px!important}.combobox .dropdown-content table{width:600px;max-width:100%;background-color:#fff}.combobox .dropdown-content table th,.combobox .dropdown-content table td{border:1px solid #b0d4eb;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:150px!important;min-width:120px!important;padding:5px}.combobox .dropdown-content table thead{position:sticky;top:-1px;color:#004671}.combobox .dropdown-content table tbody tr:hover,.combobox .dropdown-content table .active{background-color:#e6f1f8}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }]; }, propDecorators: { divElement: [{
                type: ViewChild,
                args: ['divElement']
            }], listItem: [{
                type: Input
            }], listItemFilter: [{
                type: Input
            }], itemSelected: [{
                type: Input
            }], dataTableInput: [{
                type: Input
            }], disableForm: [{
                type: Input
            }], loadMoreItemEvent: [{
                type: Output
            }], changeItemSelectedEvent: [{
                type: Output
            }], searchItemEvent: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcy10YWJsZS1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25nLXMtdGFibGUtZm9ybS9zcmMvbGliL25nLXMtdGFibGUtZm9ybS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1zLXRhYmxlLWZvcm0vc3JjL2xpYi9uZy1zLXRhYmxlLWZvcm0uY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBYyxZQUFZLEVBQWdCLEtBQUssRUFBcUIsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvSCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxZQUFZLEVBQUUsb0JBQW9CLEVBQTBCLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2RixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFRN0MsTUFBTSxPQUFPLHFCQUFxQjtJQWdCaEMsWUFBb0IsVUFBc0I7UUFBdEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQVJoQyxzQkFBaUIsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUMvRCw0QkFBdUIsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNyRSxvQkFBZSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXZFLHFCQUFnQixHQUFHLEtBQUssQ0FBQztRQUV6QixXQUFNLEdBQUcsS0FBSyxDQUFDO1FBb0NmLGlCQUFZLEdBQUcsUUFBUSxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUU7WUFDdEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUM3QixJQUFJLE1BQU0sQ0FBQyxTQUFTLEtBQUssQ0FBQyxFQUFFO2dCQUMxQixPQUFPO2FBQ1I7WUFDRCxJQUFJLE1BQU0sQ0FBQyxZQUFZLEdB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OzJGRDNCYSxxQkFBcUI7a0JBTGpDLFNBQVM7K0JBQ0UsaUJBQWlCO2lHQUtGLFVBQVU7c0JBQWxDLFNBQVM7dUJBQUMsWUFBWTtnQkFDZCxRQUFRO3NCQUFoQixLQUFLO2dCQUNHLGNBQWM7c0JBQXRCLEtBQUs7Z0JBQ0csWUFBWTtzQkFBcEIsS0FBSztnQkFDRyxjQUFjO3NCQUF0QixLQUFLO2dCQUNHLFdBQVc7c0JBQW5CLEtBQUs7Z0JBRUksaUJBQWlCO3NCQUExQixNQUFNO2dCQUNHLHVCQUF1QjtzQkFBaEMsTUFBTTtnQkFDRyxlQUFlO3NCQUF4QixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE9uQ2hhbmdlcywgT25Jbml0LCBPdXRwdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZGVib3VuY2UgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgb2YsIFN1YmplY3QsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZy1zLXRhYmxlLWZvcm0nLFxuICB0ZW1wbGF0ZVVybDogJy4vbmctcy10YWJsZS1mb3JtLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbmctcy10YWJsZS1mb3JtLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTmdTVGFibGVGb3JtQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQFZpZXdDaGlsZCgnZGl2RWxlbWVudCcpIGRpdkVsZW1lbnQ6IEVsZW1lbnRSZWY7XG4gIEBJbnB1dCgpIGxpc3RJdGVtO1xuICBASW5wdXQoKSBsaXN0SXRlbUZpbHRlcjtcbiAgQElucHV0KCkgaXRlbVNlbGVjdGVkO1xuICBASW5wdXQoKSBkYXRhVGFibGVJbnB1dDtcbiAgQElucHV0KCkgZGlzYWJsZUZvcm07XG5cbiAgQE91dHB1dCgpIGxvYWRNb3JlSXRlbUV2ZW50OiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCkgY2hhbmdlSXRlbVNlbGVjdGVkRXZlbnQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoKSBzZWFyY2hJdGVtRXZlbnQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgc2hvd0Ryb3Bkb3duTGlzdCA9IGZhbHNlO1xuICBrZXl3b3JkJDogRm9ybUNvbnRyb2w7XG4gIGluU2lkZSA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZikge31cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmtleXdvcmQkID0gbmV3IEZvcm1Db250cm9sKHRoaXMuaXRlbVNlbGVjdGVkLm5hbWUpO1xuICAgIHRoaXMuc2VhcmNoSXRlbSgpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoKSB7XG4gICAgaWYgKHRoaXMuaXRlbVNlbGVjdGVkLmNoYW5nZSkge1xuICAgICAgdGhpcy5rZXl3b3JkJD8uc2V0VmFsdWUodGhpcy5pdGVtU2VsZWN0ZWQubmFtZSwgeyBlbWl0RXZlbnQ6IGZhbHNlIH0pO1xuICAgICAgdGhpcy5pdGVtU2VsZWN0ZWQuY2hhbmdlID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgbW91c2VPdmVyVGFibGUoKSB7XG4gICAgdGhpcy5pblNpZGUgPSB0cnVlO1xuICB9XG5cbiAgbW91c2VMZWF2ZVRhYmxlKCkge1xuICAgIHRoaXMuaW5TaWRlID0gZmFsc2U7XG4gIH1cblxuICBvbkNsaWNrT3V0c2lkZSgpIHtcbiAgICBpZiAoIXRoaXMuaW5TaWRlKSB7XG4gICAgICB0aGlzLnNob3dEcm9wZG93bkxpc3QgPSBmYWxzZTtcbiAgICAgIGlmICghdGhpcy5saXN0SXRlbS5sZW5ndGggJiYgdGhpcy5pdGVtU2VsZWN0ZWQpIHtcbiAgICAgICAgdGhpcy5rZXl3b3JkJC5zZXRWYWx1ZSh0aGlzLml0ZW1TZWxlY3RlZC5uYW1lKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmxpc3RJdGVtLmxlbmd0aCAmJiB0aGlzLml0ZW1TZWxlY3RlZCAmJiAhdGhpcy5saXN0SXRlbUZpbHRlci5rZXl3b3JkKSB7XG4gICAgICAgIHRoaXMua2V5d29yZCQ/LnNldFZhbHVlKHRoaXMuaXRlbVNlbGVjdGVkLm5hbWUsIHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsb2FkTW9yZUl0ZW0gPSBkZWJvdW5jZSgoJGV2ZW50OiBhbnkpID0+IHtcbiAgICBjb25zdCB0YXJnZXQgPSAkZXZlbnQudGFyZ2V0O1xuICAgIGlmICh0YXJnZXQuc2Nyb2xsVG9wID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0YXJnZXQub2Zmc2V0SGVpZ2h0ICsgdGFyZ2V0LnNjcm9sbFRvcCA+PSB0YXJnZXQuc2Nyb2xsSGVpZ2h0IC0gNTApIHtcbiAgICAgIHRoaXMubG9hZE1vcmVJdGVtRXZlbnQuZW1pdCh0cnVlKTtcbiAgICB9XG4gIH0sIDEwMCk7XG5cbiAgY2hhbmdlSXRlbVNlbGVjdGVkKGl0ZW0sIGV2ZW50KSB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5rZXl3b3JkJC5zZXRWYWx1ZShpdGVtLm5hbWUsIHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICB0aGlzLmNoYW5nZUl0ZW1TZWxlY3RlZEV2ZW50LmVtaXQoaXRlbSk7XG4gICAgdGhpcy5zaG93RHJvcGRvd25MaXN0ID0gZmFsc2U7XG4gIH1cblxuICBzZWFyY2hJdGVtKCkge1xuICAgIHRoaXMua2V5d29yZCQudmFsdWVDaGFuZ2VzXG4gICAgICAucGlwZShcbiAgICAgICAgZGVib3VuY2VUaW1lKDUwMCksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgIHRhcCh2YWx1ZSA9PiB7XG4gICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RJdGVtRmlsdGVyLmtleXdvcmQgPSB2YWx1ZTtcbiAgICAgICAgICAgIHRoaXMubGlzdEl0ZW1GaWx0ZXIucGFnZSA9IDA7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubGlzdEl0ZW1GaWx0ZXIua2V5d29yZCA9ICcnO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLnNlYXJjaEl0ZW1FdmVudC5lbWl0KHRoaXMubGlzdEl0ZW1GaWx0ZXIua2V5d29yZCk7XG4gICAgICB9KTtcbiAgfVxufVxuIiwiPGRpdiBbbmdTdHlsZV09XCJ7ICdwb2ludGVyLWV2ZW50cyc6IGRpc2FibGVGb3JtID8gJ25vbmUnIDogJycgfVwiIGNsYXNzPVwiY29tYm9ib3hcIiAjZGl2RWxlbWVudCAoZm9jdXNvdXQpPVwib25DbGlja091dHNpZGUoKVwiIChtb3VzZW92ZXIpPVwibW91c2VPdmVyVGFibGUoKVwiIChtb3VzZWxlYXZlKT1cIm1vdXNlTGVhdmVUYWJsZSgpXCI+XHJcbiAgPCEtLSAgICA8ZGl2Pnt7aXRlbVNlbGVjdGVkIHwganNvbn19PC9kaXY+LS0+XHJcbiAgPGlucHV0IGNsYXNzPVwiaXRlbS1zZWxlY3RcIiBbdGl0bGVdPVwiaXRlbVNlbGVjdGVkLm5hbWVcIiB0eXBlPVwic2VhcmNoXCIgKGNsaWNrKT1cInNob3dEcm9wZG93bkxpc3QgPSB0cnVlXCIgW2Zvcm1Db250cm9sXT1cImtleXdvcmQkXCIgLz5cclxuICA8ZGl2IGNsYXNzPVwiZHJvcGRvd24tY29udGVudFwiICpuZ0lmPVwic2hvd0Ryb3Bkb3duTGlzdFwiIChzY3JvbGwpPVwibG9hZE1vcmVJdGVtKCRldmVudClcIj5cclxuICAgIDx0YWJsZT5cclxuICAgICAgPHRoZWFkPlxyXG4gICAgICAgIDx0cj5cclxuICAgICAgICAgIDxuZy1jb250YWluZXIgKm5nRm9yPVwibGV0IGhlYWRlciBvZiBkYXRhVGFibGVJbnB1dC5oZWFkZXJcIj5cclxuICAgICAgICAgICAgPHRoIGNsYXNzPVwiY29sLTMgdGV4dC1jZW50ZXJcIj57eyBoZWFkZXIubGFiZWwgfX08L3RoPlxyXG4gICAgICAgICAgPC9uZy1jb250YWluZXI+XHJcbiAgICAgICAgPC90cj5cclxuICAgICAgPC90aGVhZD5cclxuICAgICAgPHRib2R5PlxyXG4gICAgICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJsaXN0SXRlbS5sZW5ndGg7IGVsc2Ugbm9JdGVtXCI+XHJcbiAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0Zvcj1cImxldCBpdGVtIG9mIGxpc3RJdGVtXCI+XHJcbiAgICAgICAgICAgIDx0ciBbY2xhc3MuYWN0aXZlXT1cIml0ZW0uaWQgPT0gaXRlbVNlbGVjdGVkLmlkXCIgKGNsaWNrKT1cImNoYW5nZUl0ZW1TZWxlY3RlZChpdGVtLCAkZXZlbnQpXCI+XHJcbiAgICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdGb3I9XCJsZXQgYm9keSBvZiBkYXRhVGFibGVJbnB1dC5oZWFkZXJcIj5cclxuICAgICAgICAgICAgICAgIDx0ZFxyXG4gICAgICAgICAgICAgICAgICBbY2xhc3NdPVwiJ2NvbC0nICsgMTIgLyBkYXRhVGFibGVJbnB1dC5oZWFkZXIubGVuZ3RoXCJcclxuICAgICAgICAgICAgICAgICAgY2xhc3M9XCJpdGVtLWluZm9cIlxyXG4gICAgICAgICAgICAgICAgICBbY2xhc3MuY29sLTJdPVwiYm9keS52YWx1ZSA9PSAndGF4Q29kZSdcIlxyXG4gICAgICAgICAgICAgICAgICBbdGl0bGVdPVwiaXRlbVtib2R5LnZhbHVlXVwiXHJcbiAgICAgICAgICAgICAgICA+XHJcbiAgICAgICAgICAgICAgICAgIHt7IGl0ZW1bYm9keS52YWx1ZV0gfX1cclxuICAgICAgICAgICAgICAgIDwvdGQ+XHJcbiAgICAgICAgICAgICAgPC9uZy1jb250YWluZXI+XHJcbiAgICAgICAgICAgIDwvdHI+XHJcbiAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cclxuICAgICAgICA8L25nLWNvbnRhaW5lcj5cclxuICAgICAgICA8bmctdGVtcGxhdGUgI25vSXRlbT5cclxuICAgICAgICAgIDx0cj5cclxuICAgICAgICAgICAgPHRkIGNvbHNwYW49XCI0XCI+ROG7ryBsaeG7h3Uga2jDtG5nIHThu5NuIHThuqFpIHRyb25nIGRhbmggbeG7pWM8L3RkPlxyXG4gICAgICAgICAgPC90cj5cclxuICAgICAgICA8L25nLXRlbXBsYXRlPlxyXG4gICAgICA8L3Rib2R5PlxyXG4gICAgPC90YWJsZT5cclxuICA8L2Rpdj5cclxuPC9kaXY+XHJcbiJdfQ==